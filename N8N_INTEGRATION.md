# üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SMS-–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å N8N

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS —á–µ—Ä–µ–∑ OpenPhone –∏ **–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback –≤ N8N** –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   N8N   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Webhook    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Queue   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇOpenPhone‚îÇ
‚îÇ(–≤—Ö–æ–¥–Ω–æ–π)‚îÇ      ‚îÇ(/webhook/send)‚îÇ      ‚îÇ  Service  ‚îÇ      ‚îÇ Browser ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ
                                              ‚ñº
                                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                        ‚îÇ Supabase ‚îÇ
                                        ‚îÇ   (–ª–æ–≥)  ‚îÇ
                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                              ‚îÇ
                                              ‚ñº
                                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                        ‚îÇ   N8N    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚úÖ CALLBACK
                                        ‚îÇ Webhook  ‚îÇ
                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ N8N Webhook Callback

### 1. –°–æ–∑–¥–∞–π—Ç–µ Webhook –≤ N8N

–í –≤–∞—à–µ–º N8N workflow:

1. –î–æ–±–∞–≤—å—Ç–µ —É–∑–µ–ª **Webhook**
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ **HTTP Method**: `POST`
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Production URL** (–∏–ª–∏ Test URL)

–ü—Ä–∏–º–µ—Ä URL:
```
https://wheelsfeels.app.n8n.cloud/webhook-test/4064282f-1891-481b-b116-68b4523f5c30
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env` —Ñ–∞–π–ª

–î–æ–±–∞–≤—å—Ç–µ URL webhook –≤ —Ñ–∞–π–ª `.env`:

```bash
N8N_WEBHOOK_URL=https://wheelsfeels.app.n8n.cloud/webhook-test/4064282f-1891-481b-b116-68b4523f5c30
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
npm run build
npm start

# –í Docker
docker-compose down
docker-compose up -d --build
```

## üì¶ –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö Callback

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ SMS —Å–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç POST –∑–∞–ø—Ä–æ—Å –≤ N8N —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

### ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

```json
{
  "success": true,
  "status": "sent",
  "phone": "+1234567890",
  "external_id": "your_custom_id",
  "timestamp": "2026-01-17T10:30:45.123Z",
  "attempt": 1,
  "duration_ms": 15234
}
```

### ‚ùå –ù–µ—É–¥–∞—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

```json
{
  "success": false,
  "status": "failed",
  "phone": "+1234567890",
  "external_id": "your_custom_id",
  "timestamp": "2026-01-17T10:30:45.123Z",
  "attempt": 3,
  "duration_ms": 12500,
  "error": {
    "code": "TIMEOUT",
    "message": "Navigation timeout"
  },
  "screenshot_url": "screenshots/error-1737108645123-1234567890.png"
}
```

### üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞

```json
{
  "success": false,
  "status": "retrying",
  "phone": "+1234567890",
  "external_id": "your_custom_id",
  "timestamp": "2026-01-17T10:30:45.123Z",
  "attempt": 1,
  "duration_ms": 8500,
  "error": {
    "code": "NETWORK_ERROR",
    "message": "Connection timeout"
  }
}
```

## üé® –ü—Ä–∏–º–µ—Ä N8N Workflow

### –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ SMS (HTTP Request)

```
POST http://localhost:3000/webhook/send
Content-Type: application/json

{
  "phone": "+1234567890",
  "text": "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
  "external_id": "order_12345"
}
```

### –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ Callback (Webhook)

N8N –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç callback —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º:

```javascript
// –í N8N –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ:
const success = $json.success;
const status = $json.status;
const phone = $json.phone;
const externalId = $json.external_id;

if (success) {
  console.log(`‚úÖ SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${phone}`);
} else {
  console.log(`‚ùå –û—à–∏–±–∫–∞: ${$json.error.message}`);
}
```

### –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–í—ã –º–æ–∂–µ—Ç–µ:
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π workflow
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

## üîç –°—Ç–∞—Ç—É—Å—ã —Å–æ–æ–±—â–µ–Ω–∏–π

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `sending` | –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è |
| `sent` | ‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ |
| `failed` | ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å |
| `retrying` | üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ |

## üõ†Ô∏è –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook

```bash
curl -X POST https://wheelsfeels.app.n8n.cloud/webhook-test/4064282f-1891-481b-b116-68b4523f5c30 \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
```

### –õ–æ–≥–∏

–í—Å–µ callback –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
```
2026-01-17 10:30:45 [info] : Sending callback to N8N for +***90 (status: sent)
2026-01-17 10:30:45 [info] : ‚úÖ N8N callback sent successfully for +***90
```

–ï—Å–ª–∏ callback –æ—Ç–∫–ª—é—á–µ–Ω:
```
2026-01-17 10:30:45 [debug] : N8N webhook disabled, skipping callback
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **Callback –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `N8N_WEBHOOK_URL` –≤ `.env`
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –≤ N8N –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (Production mode)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f logs/combined.log`

2. **–û—à–∏–±–∫–∞ "Webhook returned 404"**
   - URL webhook –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ webhook –±—ã–ª —É–¥–∞–ª–µ–Ω
   - –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π webhook –≤ N8N

3. **Timeout –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ callback**
   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –∏–ª–∏ N8N –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
   - Callback –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É SMS (fail-safe)

## üìä –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–≥–æ workflow –≤ N8N

```mermaid
graph LR
    A[Trigger] --> B[HTTP Request: –û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS]
    B --> C[Webhook: –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç]
    C --> D{–£—Å–ø–µ—à–Ω–æ?}
    D -->|–î–∞| E[–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å ‚úÖ]
    D -->|–ù–µ—Ç| F{–ü–æ–≤—Ç–æ—Ä–∏—Ç—å?}
    F -->|–î–∞| B
    F -->|–ù–µ—Ç| G[–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚ùå]
```

## üöÄ Production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏
- ‚úÖ Fail-safe: –æ—à–∏–±–∫–∏ callback –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç SMS
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase + –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ N8N

---

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ SMS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –≤–∞—à N8N workflow! üéâ
